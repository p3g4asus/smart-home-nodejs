<!--
@license
Copyright 2017, Google, Inc.
Licensed under the Apache License, Version 2.0 (the 'License');
you may not use this file except in compliance with the License.
You may obtain a copy of the License at
    http://www.apache.org/licenses/LICENSE-2.0
Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an 'AS IS' BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.
-->

<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, minimum-scale=1, initial-scale=1, user-scalable=yes">

    <title>Smart Home Provider</title>
    <meta name="description" content="Smart Home virtual devices">

    <link rel="icon" href="images/favicon.ico">

    <!-- See https://goo.gl/OOhYW5 for web app manifests -->
    <link rel="manifest" href="manifest.json">

    <!-- See https://goo.gl/qRE0vM for Chrome on Android theme-color attribute -->
    <meta name="theme-color" content="#3f51b5">

    <!-- Add to homescreen for Chrome on Android. Fallback for manifest.json -->
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="application-name" content="Smart Home Gizmos">

    <!-- Add to homescreen for Safari on iOS -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Smart Home Gizmos">

    <!-- Homescreen icons -->
    <link rel="apple-touch-icon" href="images/manifest/icon-48x48.png">
    <link rel="apple-touch-icon" sizes="72x72" href="images/manifest/icon-72x72.png">
    <link rel="apple-touch-icon" sizes="96x96" href="images/manifest/icon-96x96.png">
    <link rel="apple-touch-icon" sizes="144x144" href="images/manifest/icon-144x144.png">
    <link rel="apple-touch-icon" sizes="192x192" href="images/manifest/icon-192x192.png">

    <!-- Tile icon for Windows 8 (144x144 + tile color) -->
    <meta name="msapplication-TileImage" content="images/manifest/icon-144x144.png">
    <meta name="msapplication-TileColor" content="#3f51b5">
    <meta name="msapplication-tap-highlight" content="no">

    <!-- login -->
    <meta name="google-signin-scope" content="profile email">
    <script src="bower_components/webcomponentsjs/webcomponents-lite.js"></script>
	<script src="bower_components/web-animations-js/web-animations.min.js"></script>
	<!--<script src="/getauthcode"></script>-->
    <script>
        const SMART_HOME_PROVIDER_CLOUD_ENDPOINT = '/smart-home-api';

        // Setup Polymer options
        window.Polymer = {
            dom: 'shadow',
            lazyRegister: true
        };

        // Load webcomponentsjs polyfill if browser does not support native Web Components
        /*(function() {
            'use strict';

            var onload = function() {
                // For native Imports, manually fire WebComponentsReady so user code
                // can use the same code path for native and polyfill'd imports.
                if (!window.HTMLImports) {
                    document.dispatchEvent(
                        new CustomEvent('WebComponentsReady', {
                            bubbles: true
                        })
                    );
                }
            };

            var webComponentsSupported = (
                'registerElement' in document &&
                'import' in document.createElement('link') &&
                'content' in document.createElement('template')
            );

            if (!webComponentsSupported) {
                var script = document.createElement('script');
                script.async = true;
                script.src = 'bower_components/webcomponentsjs/webcomponents-lite.js';
                script.onload = onload;
                document.head.appendChild(script);
            } else {
                onload();
            }
        })();*/

        // Load pre-caching Service Worker
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', function() {
                navigator.serviceWorker.register('service-worker.js');
            });
        }
    </script>

    <link rel="import" href="bower_components/polymer/polymer.html">
	<link rel="import" href="bower_components/polymer/polymer-element.html">
    <link rel="import" href="bower_components/app-layout/app-header/app-header.html">
    <link rel="import" href="bower_components/app-layout/app-scroll-effects/app-scroll-effects.html">
    <link rel="import" href="bower_components/app-layout/app-toolbar/app-toolbar.html">
    <link rel="import" href="bower_components/iron-form/iron-form.html">
    <link rel="import" href="bower_components/iron-icon/iron-icon.html">
    <link rel="import" href="bower_components/iron-icons/iron-icons.html">
    <link rel="import" href="bower_components/iron-icons/communication-icons.html">
    <link rel="import" href="bower_components/iron-icons/device-icons.html">
    <link rel="import" href="bower_components/iron-icons/editor-icons.html">
    <link rel="import" href="bower_components/iron-icons/social-icons.html">
    <link rel="import" href="bower_components/iron-list/iron-list.html">
    <link rel="import" href="bower_components/paper-dialog/paper-dialog.html">
	<link rel="import" href="bower_components/neon-animation/web-animations.html">
    <link rel="import" href="bower_components/paper-input/paper-input.html">
    <link rel="import" href="bower_components/paper-input/paper-textarea.html">
    <link rel="import" href="bower_components/paper-checkbox/paper-checkbox.html">
    <link rel="import" href="bower_components/paper-button/paper-button.html">
    <link rel="import" href="bower_components/paper-listbox/paper-listbox.html">
    <link rel="import" href="bower_components/paper-item/paper-item.html">
    <link rel="import" href="bower_components/paper-item/paper-item-body.html">
    <link rel="import" href="bower_components/paper-item/paper-icon-item.html">
    <link rel="import" href="bower_components/paper-spinner/paper-spinner-lite.html">
    <link rel="import" href="bower_components/paper-styles/color.html">
    <link rel="import" href="bower_components/paper-icon-button/paper-icon-button.html">
    <link rel="import" href="bower_components/paper-dropdown-menu/paper-dropdown-menu.html">
    <link rel="import" href="bower_components/paper-icon-button/paper-icon-button.html">
    <link rel="import" href="bower_components/paper-toast/paper-toast.html">
	<link rel="import" href="bower_components/iron-flex-layout/iron-flex-layout-classes.html">
    <link rel="import" href="bower_components/vaadin-form-layout/vaadin-form-layout.html">
    <link rel="import" href="bower_components/vaadin-form-layout/vaadin-form-item.html">

    <style>
    body {
        margin: 0;
        font-family: 'Roboto', 'Noto', sans-serif;
        line-height: 1.5;
        min-height: 100vh;
        background-color: #eeeeee;
    }
	</style>
<dom-module id="shared-styles">
	<template>
		<style>
		paper-button.custom {
			--paper-button-ink-color: var(--paper-pink-a200);
			/* These could also be individually defined for each of the
				specific css classes, but we'll just do it once as an example */
			--paper-button-flat-keyboard-focus: {
				background-color: var(--paper-pink-a200);
				color: white !important;
			}
			;
			--paper-button-raised-keyboard-focus: {
				background-color: var(--paper-pink-a200) !important;
				color: white !important;
			}
			;
		}

		paper-button.custom:hover {
			background-color: var(--paper-indigo-100);
		}

		paper-button.pink {
			color: var(--paper-pink-a200);
		}

		paper-button.indigo {
			background-color: var(--paper-indigo-500);
			color: white;
			--paper-button-raised-keyboard-focus: {
				background-color: var(--paper-pink-a200) !important;
				color: white !important;
			}
			;
		}
		paper-button[disabled] {
			background-color: #eadbd8;
			color: #4285f4;
		}
		vaadin-form-item.largespace * {
			margin-bottom: .5em;
		}
		vaadin-form-item.midpace * {
			margin-bottom: 2em;
		}
		</style>
	</template>
</dom-module>
<dom-module id="remote-list">
    <template>
		<custom-style>
			<style is="custom-style" include="shared-styles iron-flex iron-flex-alignment">
				paper-listbox {
					border: 1px solid #e5e5e5;
				}
				.avatar {
					display: inline-block;
					box-sizing: border-box;
					width: 40px;
					height: 40px;
					border-radius: 50%;
					background: var(--paper-amber-500);
				}
				.defaultclass {
					color: var(--paper-yellow-a700);
				}

				vaadin-form-item {
					--vaadin-form-item-label-width: 0em;
				}

				.baseclass:enabled {
					color: black;
				}

				.baseclass:disabled {
					opacity: 0.65;
					cursor: not-allowed;
				}

				vaadin-form-item {
					--vaadin-form-item-row-spacing: 1em;
				}
				.scrollpane {
					display:block;
					height:15em;
					overflow-y: auto;
				}

				paper-textarea {
				  display: block;
				  width: 30em;
				  --iron-autogrow-textarea: {
					font-family: monospace;
					font-size: .7em;
				  };
				}
				paper-icon-button[hidden] {
					display: none;
				}

				paper-listbox[hidden] {
					display: none;
				}

				paper-dropdown-menu[hidden] {
					display: none;
				}

				.hidden {
					display: none;
				}

				.padded-both {
					padding-left: 10px;
					padding-right: 10px;
				}

				.padded-item {
					padding-left: 5px;
				}

				:host{
					  --paper-input-container-input:{
						max-height: 8em;
					  }
				}

				.error-toast {
					--paper-toast-background-color: var(--paper-red-900);
					--paper-toast-color: white;
				}

				.ok-toast {
					--paper-toast-background-color: var(--paper-green-900);
					--paper-toast-color: white;
				}

				.warn-toast {
					--paper-toast-background-color: var(--paper-yellow-900);
					--paper-toast-color: black;
				}

				.plain-toast {

				}
			</style>
		</custom-style>
		<vaadin-form-layout id="deviceslayout">
			<vaadin-form-item colspan="3">
				<div id="deviceslb-scroll" class$="scrollpane [[getDRKListClass(devicesList)]]">
					<paper-listbox disabled=$[[disabled]] scroll-target="deviceslb-scroll" id="deviceslb" on-selected-changed="onDeviceSelected">
						<dom-repeat items="{{devicesList}}">
							<template>
								<paper-icon-item>
									<iron-icon slot="item-icon" icon="{{getDeviceIcon(item,item.type)}}"></iron-icon>
									<paper-item-body two-line>
										<div>{{item.devicenick}}</div>
										<div secondary>{{item.device}}</div>
									</paper-item-body>
									<paper-icon-button on-click="setRenameDevice" class="baseclass" icon="editor:mode-edit"></paper-icon-button>
									<paper-icon-button disabled$=[[getLearnKeyButtonDisabled(item,item.type,connected)]] on-click="setLearnKeyRemote" class="baseclass" icon="icons:lightbulb-outline"></paper-icon-button>
								</paper-icon-item>
							</template>
						</dom-repeat>
					</paper-listbox>
				</div>
			</vaadin-form-item>
			<vaadin-form-item colspan="3">
				<div id="remoteslb-scroll" class$="scrollpane [[getDRKListClass(remotesList)]]">
					<paper-listbox disabled=$[[disabled]] id="remoteslb" scroll-target="remoteslb-scroll" on-selected-changed="onRemoteSelected">
						<dom-repeat items="{{remotesList}}">
							<template>
								<paper-icon-item>
									<div class="avatar" style$="{{getRemoteColor(item)}}" slot="item-icon"></div>
									<paper-item-body two-line>
										<div>{{item.remotenick}}</div>
										<div secondary>{{item.remote}}</div>
									</paper-item-body>
									<paper-icon-button disabled$="[[getDefaultRemoteButtonDisabled(item,item.type)]]" on-click="setDefaultRemote" icon="icons:star" class$="{{getDefaultRemoteClass(item,item.default)}}"></paper-icon-button>
									<paper-icon-button disabled$="[[getRenameRemoteButtonDisabled(item,item.type)]]" on-click="setRenameRemote" class="baseclass" icon="editor:mode-edit"></paper-icon-button>
									<!-- icons:radio-button-unchecked / icons:radio-button-checked -->
									<paper-icon-button disabled$="[[getSelectedRemoteButtonDisabled(item,item.type)]]" on-click="setSelectedRemote" class="baseclass" icon="{{getSelectedRemoteIcon(item,item.filtered)}}"></paper-icon-button>
									<paper-icon-button disabled$=[[getLearnKeyButtonDisabled(item,item.type,connected)]] on-click="setLearnKeyRemote" class="baseclass" icon="icons:lightbulb-outline"></paper-icon-button>
								</paper-icon-item>
							</template>
						</dom-repeat>
					</paper-listbox>
				</div>
			</vaadin-form-item>
			<paper-toast id="toastnotify" text="This toast is red and fits bottom!"></paper-toast>
			<iron-ajax id="serviceajax" reject-with-request="true" method="GET" handle-as="json" debounce-duration="300" url="/emitkey" headers="[[getAuthHeader('application/json',AUTH_TOKEN)]]"> </iron-ajax>
			<vaadin-form-item colspan="3">
				<div id="keyslb-scroll" class$="scrollpane [[getDRKListClass(keysList)]]">
					<paper-listbox disabled=$[[disabled]] id="keyslb" scroll-target="keyslb-scroll">
						<dom-repeat items="{{keysList}}">
							<template>
								<paper-icon-item>
									<div class="avatar" style$="{{getRemoteColor(item)}}" slot="item-icon"></div>
									<paper-item-body two-line>
										<div>{{item.remotenick}}</div>
										<div secondary>{{item.remote}}</div>
									</paper-item-body>
									<paper-icon-button disabled$=[[getLearnKeyButtonDisabled(item,item.type,connected)]] on-click="setLearnKeyRemote" class="baseclass" icon="icons:lightbulb-outline"></paper-icon-button>
									<paper-icon-button disabled$=[[getEmitKeyButtonDisabled(item,item.type,connected)]] on-click="emitKeyDo" class="baseclass" icon="icons:settings-input-antenna"></paper-icon-button>
									<paper-icon-button class="baseclass" icon="{{getSelectedKeyIcon(item,item.filtered)}}"></paper-icon-button>
									<paper-icon-button disabled$="[[getRenameKeyButtonDisabled(item,item.type)]]" on-click="setRenameKey" class="baseclass" icon="editor:mode-edit"></paper-icon-button>
								</paper-icon-item>
							</template>
						</dom-repeat>
					</paper-listbox>
				</div>
			</vaadin-form-item>
			<!--<vaadin-form-item class="largespace" colspan="1">
				<paper-input label="ID" value="{{itemRename.device}}/{{itemRename.remote}}" readonly=true placeholder="ID"></paper-input>
				<paper-input label="Device Name" value={{itemRename.devicenick}} disabled$=[[getRenameDeviceInputDisabled(itemRename.idx,itemRename.type)]] id="devicename" placeholder="Device Name" required pattern="^[0-9a-zA-Z \-\+&]+$"></paper-input>
				<paper-input label="Remote Name" value={{itemRename.remotenick}} disabled$=[[getRenameRemoteInputDisabled(itemRename.idx,itemRename.type)]] id="remotename" placeholder="Remote Name" required pattern="^[0-9a-zA-Z \-\+&]+$"></paper-input>
				<paper-button class="custom indigo" id="applyrename" on-click="renameAll" disabled$=[[getRenameButtonDisabled(itemRename.idx,itemRename.type)]]>Rename</paper-button>
			</vaadin-form-item>-->
			<!--<vaadin-form-item colspan="2">
				<div class="layout horizontal end">
					<paper-textarea
						class="flex"
						rows="6"
						max-rows="6"
						placeholder="Raw"
						readolnly=[[getRawKeyInputDisabled(itemRaw)]]
						value="{{itemRaw.raw}}"></paper-textarea>

					<paper-icon-button
						icon="icons:check"
						disabled$=[[getRawKeyInputDisabled(itemRaw)]]
						on-tap="setRawKeyInputOK"></paper-icon-button>

					<paper-icon-button
						icon="icons:clear"
						disabled$=[[getRawKeyInputDisabled(itemRaw)]]
						on-tap="setRawKeyInputCancel"></paper-icon-button>
				</div>
			</vaadin-form-item>-->
		</vaadin-form-layout>
		<paper-dialog class id="shdialog" modal>
			<h1>Sh for device [[learnDevice.device]]/[[learnDevice.devicenick]]</h1>
			<paper-dialog-scrollable>
				<div id="shdialog-scroll" class="scrollpane">
				<!--<div class="layout vertical end">-->
					<paper-input flex invalid=[[shDialogNameInvalid(shLearn)]] class="padded-item" label="Sh Name" id="shdialog-input-shname" value="{{shLearn}}"></paper-input>
					<paper-listbox disabled=$[[disabled]] id="shdialoglb">
						<dom-repeat items="{{learnDialogList}}">
							<template>
								<paper-item>
									<div class="layout horizontal end">
										<paper-dropdown-menu colspan="2" invalid=[[shDialogGetP1ComboInvalid(item.idx,item.p0,item.p1,item.p2)]] class="padded-item" label="Remote" id="shdialog-drop-p1-[[item.idx]]">
											<paper-listbox slot="dropdown-content" attr-for-selected="value" selected="{{item.p1}}">
												<template is="dom-repeat" items="{{learnDialogRemotesList}}" as="remote">
													<paper-item value="{{remote.remote}}">{{remote.remote}}</paper-item>
												</template>
											</paper-listbox>
										</paper-dropdown-menu>
										<paper-dropdown-menu colspan="2" class="padded-item" invalid=[[shDialogGetP2ComboInvalid(item.idx,item.p0,item.p1,item.p2)]] hidden$=[[shDialogGetKeysListHidden(item.p1)]] label="Key" id="shdialog-drop-p2-[[item.idx]]">
											<paper-listbox slot="dropdown-content" hidden$=[[shDialogGetKeysListHidden(item.p1)]] attr-for-selected="value" selected="{{item.p2}}">
												<template is="dom-repeat" items="[[getShDialogKeysList(item.p1)]]" as="key">
													<paper-item value="{{key.remote}}">{{key.remote}}</paper-item>
												</template>
											</paper-listbox>
										</paper-dropdown-menu>
										<paper-input colspan="3" label="Delay (s)" hidden$=[[!shDialogGetKeysListHidden(item.p1)]] invalid=[[shDialogGetP0InputInvalid(item.idx,item.p0,item.p1,item.p2)]] class="padded-item" id="shdialog-input-p0-[[item.idx]]" value="{{item.p0}}"></paper-input>
										<paper-icon-button class="baseclass" on-click="learnDialogRemoveLine" disabled$=[[learnDialogGetRemoveButtonDisabled(item.idx,item.p0,item.p1,item.p2,item.last)]] icon="remove"></paper-icon-button>
										<paper-icon-button class="baseclass" on-click="shDialogAddLine" disabled$=[[shDialogGetAddButtonDisabled(item.idx,item.p0,item.p1,item.p2,item.last)]] icon="add"></paper-icon-button>
									</div>
								</paper-item>
							</template>
						</dom-repeat>
					</paper-listbox>
				<!--</div>-->
				</div>
			</paper-dialog-scrollable>
			<div class="buttons">
				<paper-button disabled$=[[!shDialogElementsOk]] on-click="createShDo">Create/Edit</paper-button>
				<paper-button class autofocus dialog-confirm>Tap me to close</paper-button>
			</div>
		</paper-dialog>
		<paper-dialog class id="learndialog" modal>
			<h1>Learn key with device [[learnDevice.device]]/[[learnDevice.devicenick]]</h1>
			<paper-dialog-scrollable class>
				<div id="shdialog-scroll" class="scrollpane">
				<paper-listbox disabled=$[[disabled]] id="learndialoglb">
					<dom-repeat items="{{learnDialogList}}" id="learndialogrep">
						<template>
							<paper-item>
								<div class="layout horizontal end">
									<paper-dropdown-menu colspan="2" invalid=[[learnDialogGetP1ComboInvalid(item.idx,item.p0,item.p1,item.p2)]] class="padded-item" label="Existent Remote" id="learndialog-drop-p1-[[item.idx]]">
										<paper-listbox slot="dropdown-content" id="learndialog-drop-list-p1-[[item.idx]]" attr-for-selected="value" selected="{{item.p1}}">
											<template is="dom-repeat" items="{{learnDialogRemotesList}}" as="remote">
												<paper-item value="{{remote.remote}}">{{remote.remote}}</paper-item>
											</template>
										</paper-listbox>
									</paper-dropdown-menu>
									<paper-input colspan="3" invalid=[[learnDialogGetP0InputInvalid(item.idx,item.p0,item.p1,item.p2)]] disabled$=[[learnDialogGetP0InputDisabled(item.idx,item.p0,item.p1,item.p2)]] class="padded-item" id="learndialog-input-p0-[[item.idx]]" value="{{item.p0}}"></paper-input>
									<paper-input colspan="3" label="Key" invalid=[[learnDialogGetP2InputInvalid(item.idx,item.p0,item.p1,item.p2)]] class="padded-item" id="learndialog-input-p2-[[item.idx]]" value="{{item.p2}}"></paper-input>
									<paper-icon-button class="baseclass" on-click="learnDialogRemoveLine" disabled$=[[learnDialogGetRemoveButtonDisabled(item.idx,item.p0,item.p1,item.p2,item.last)]] icon="remove"></paper-icon-button>
									<paper-icon-button class="baseclass" on-click="learnDialogAddLine" disabled$=[[learnDialogGetAddButtonDisabled(item.idx,item.p0,item.p1,item.p2,item.last)]] hidden$=[[learnDialogGetAddButtonHidden(item.idx,item.p0,item.p1,item.p2,item.last)]] icon="add"></paper-icon-button>
								</div>
							</paper-item>
						</template>
					</dom-repeat>
				</paper-listbox>
				</div>
			</paper-dialog-scrollable>
			<div class="buttons">
				<paper-button disabled$=[[!learnDialogElementsOk]] on-click="learnKeysDo">Learn</paper-button>
				<paper-button class autofocus dialog-confirm>Tap me to close</paper-button>
			</div>
		</paper-dialog>
		<paper-dialog class id="renamedialog" modal>
			<p class>Rename {{itemRename.device}}/{{itemRename.remote}}</p>
			<paper-dialog-scrollable class>
				<div class="layout vertical end">
					<paper-input class="padded-both" label=[[getRenameF1Label(itemRename.type)]] value={{itemRename.devicenick}} disabled$=[[getRenameDeviceInputDisabled(itemRename.idx,itemRename.type)]] id="devicename" placeholder=[[getRenameF1Label(itemRename.type)]] invalid=[[getDeviceNameInvalid(itemRename.devicenick,itemRename.type)]]></paper-input>
					<paper-input class="padded-both" label=[[getRenameF2Label(itemRename.type)]] value={{itemRename.remotenick}} disabled$=[[getRenameRemoteInputDisabled(itemRename.idx,itemRename.type)]] id="remotename" placeholder=[[getRenameF2Label(itemRename.type)]] invalid=[[getRemoteNameInvalid(itemRename.remotenick,itemRename.type)]]></paper-input>
					<paper-button class="custom indigo" id="applyrename" on-click="renameAll" disabled$=[[getRenameButtonDisabled(itemRename.idx,itemRename.devicenick,itemRename.remotenick,itemRename.type)]]>Rename</paper-button>
					<div class="layout horizontal end padded-both [[getRawDevClass(itemRename.type)]]">
						<paper-textarea
							class$="padded-both [[getRawDevClass(itemRename.type)]]"
							rows="4"
							max-rows="4"
							placeholder="Raw"
							readolnly=[[getRawKeyInputDisabled(itemRename.raw,itemRename.type)]]
							value="{{itemRename.raw}}"></paper-textarea>

						<!--editor:mode-edit icons:check-->
						<paper-icon-button
							class$="padded-both [[getRawDevClass(itemRename.type)]]"
							icon="icons:check"
							disabled$=[[getRawKeyInputDisabled(itemRename.raw,itemRename.type)]]
							on-tap="setRawKeyInputOK"></paper-icon-button>

						<paper-icon-button
							class$="padded-both [[getRawDevClass(itemRename.type)]]"
							icon="icons:clear"
							disabled$=[[getRawKeyInputDisabled(itemRename.raw,itemRename.type)]]
							on-tap="setRawKeyInputCancel"></paper-icon-button>
					</div>
				</div>
			</paper-dialog-scrollable>
			<div class="buttons">
				<paper-button class autofocus dialog-confirm>Tap me to close</paper-button>
			</div>
		</paper-dialog>
    </template>
</dom-module>

<dom-module id="connection-form">
	<template>
		<custom-style>
			<style is="custom-style" include="shared-styles iron-flex iron-flex-alignment">
				app-header {
					color: #fff;
					background-color: #4285f4;
				}

				app-header paper-icon-button {
					--paper-icon-button-ink-color: white;
				}

				.preferred {
					color: yellow;
				}

				paper-spinner-lite.orange {
					--paper-spinner-color: var(--google-yellow-500);
				}

				paper-checkbox.blue {
					--paper-checkbox-checked-color: var(--paper-blue-500);
					--paper-checkbox-checked-ink-color: var(--paper-blue-500);
					--paper-checkbox-unchecked-color: var(--paper-blue-900);
					--paper-checkbox-unchecked-ink-color: var(--paper-blue-900);
					--paper-checkbox-label-color: var(--paper-blue-700);
					--paper-checkbox-label-checked-color: var(--paper-blue-900);
				}

				paper-checkbox .title {
					display: block;
					font-size: 1.2em;
				}

				vaadin-form-item {
					--vaadin-form-item-row-spacing: 1em;
				}
			</style>
		</custom-style>
		<iron-ajax id="authcodeajax" reject-with-request="true" method="GET" handle-as="json" debounce-duration="300" url="/getauthcode" headers='{"Content-Type": "application/json", "Accept": "application/json"}'> </iron-ajax>
		<iron-ajax id="optionsajax" reject-with-request="true" method="GET" handle-as="json" debounce-duration="300" url="/jsonoptions" headers="[[getAuthHeader('application/json',AUTH_TOKEN)]]"> </iron-ajax>
		<iron-ajax id="submitajax" reject-with-request="true" method="POST" handle-as="json" debounce-duration="300" url="/jsonoptions" headers="[[getAuthHeader('application/json',AUTH_TOKEN)]]"> </iron-ajax>
		<iron-form id="optionsform" allow-redirects="true" headers="[[getAuthHeader('application/json',AUTH_TOKEN)]]">
			<form action='/jsonoptions' method='post' id="optionsforminner">

				<connection-validator name="host" pattern="^[A-Za-z0-9_\-\.]+$"
					error-message={{hostErrorMessage}} extern-error=[[connectionError]]></connection-validator>
				<connection-validator name="port" pattern="65535"
					error-message={{portErrorMessage}} extern-error=[[connectionError]]></connection-validator>
				<vaadin-form-layout id="connformlayout">
					<vaadin-form-item colspan="3" style="--vaadin-form-item-label-width: 4em;">
						<remote-list id="remotelist" uid={{data.uid}} AUTH_TOKEN="{{AUTH_TOKEN}}" host="{{data.host}}" port="{{data.port}}" connected="{{data.connected}}" devices-list={{devicesList}}></remote-list>
					</vaadin-form-item>
					<vaadin-form-item colspan="2" label-position="top">
						<label slot="label">OrvPy Connection</label>
						<paper-input label="Host" error-message=[[hostErrorMessage]] value={{data.host}} id="host" placeholder="Host" validator="connection-validator-host"></paper-input>
						<paper-input label="Port" error-message=[[portErrorMessage]] value={{data.port}} id="port" placeholder="Port" validator="connection-validator-port"></paper-input>
					</vaadin-form-item>

					<vaadin-form-item class="largespace">
						<paper-dropdown-menu label="Language" id="labelcombo">
							<paper-listbox slot="dropdown-content" id="language" attr-for-selected="value" selected="{{data.language}}">
								<paper-item value="it">it</paper-item>
								<paper-item value="en">en</paper-item>
							</paper-listbox>
						</paper-dropdown-menu>
						<br />
						<paper-checkbox id="autologin" class="blue" checked="{{data.autologin}}">
							<span class="title">Autologin</span>
						</paper-checkbox>
						<br />
						<paper-button class="custom indigo" id="testbutton" on-click="testConnection">Test</paper-button>
						<paper-spinner-lite class="orange" id="testspinner"></paper-spinner-lite>
					</vaadin-form-item>
					<vaadin-form-item>
						<paper-button class="custom indigo" id="optionssubmit" on-click="submitform">Submit</paper-button>
					</vaadin-form-item>
				</vaadin-form-layout>
			</form>
		</iron-form>
	</template>
</dom-module>

	<script>
	function getUrlParameters() {
		// Get each parameter
		let query = window.location.search.substr(1);
		// Split each parameter into a key-value pair
		let keyValues = query.split('&');
		let parameterMap = new Map();
		for (let i in keyValues) {
			// Split into <key>=<value>
			let param = keyValues[i];
			let splitParam = param.split('=');
			parameterMap.set(splitParam[0], splitParam[1]);
		}
		return parameterMap;
	}
HTMLImports.whenReady(() => {

	class ConnectionValidator extends Polymer.mixinBehaviors([Polymer.IronValidatorBehavior], Polymer.Element) {
		static get is() {
			return 'connection-validator';
		}
		static get properties() {
			return {
				pattern : {
					type: String
				},
				name : {
					type: String
				},
				errorMessage: {
					type: String,
					notify: true
				},
				oldresult: {
					type: Number,
					value: -1
				},
				externError: {
					type: String,
					value: ''
				},
				oldvalue: {
					type: String,
					value: null
				}
			}
		}
		ready() {
			super.ready();

			// Workaround https://github.com/PolymerElements/iron-validator-behavior/issues/30#issuecomment-305643574
			new Polymer.IronMeta({
				type: 'validator',
				key: ConnectionValidator.is+"-"+this.name,
				value: this
			});
		}

		validate(value) {
			console.log("AT1 " + this.externError + " ov " + this.oldvalue + " v " + value+" n "+this.name);
			if (typeof value == "undefined")
				return true;

			if (this.externError.length>0 && (this.oldvalue == value || this.oldresult<0)) {
				this.set('errorMessage',this.externError);
				this.oldresult = 0;
				return false;
			} else if (this.oldvalue == value && this.oldresult>=0)
				return this.oldresult>0;
			this.set('externError',"");
			this.oldvalue = value;
			if (!value || value.length < 2) {
				this.set('errorMessage',"Field should be at least 2 character long.");
				this.oldresult = 0;
				return false;
			}
			let isInt = -1;
			if (/^[0-9]+$/.exec(this.pattern)) {
				isInt = parseInt(this.pattern);
				console.log("isint "+isInt);
			}
			if (isInt>0) {
				let elem = -1;
				if (/^[0-9]+$/.exec(value)) {
					elem = parseInt(value);
					console.log('elem '+elem);
				}
				if (elem<0 || elem>isInt) {
					this.set('errorMessage', "Field should be from >0 && <="+isInt+".");
					this.oldresult = 0;
					return false;
				}
			}
			else {
				let res = new RegExp(this.pattern).test(value);
				if (!res) {
					this.set('errorMessage', "Field should contain only digits, letters, dashes, dots or underscores.");
					this.oldresult = 0;
					return false;
				}
			}
			this.oldresult = 1;
			return true;
		}
	}

	/*class RemoteItem extends Polymer.Element {
		static get is() {
			return 'remote-item';
		}
		static get properties() {
			return {
				deflt: {
					type: Boolean,
					value: false
				},
				name: {
					type: String
				},
				device: {
					type: String
				},
				color: {
					type: String
				},
				keys: {
					type: Array,
					value: []
				}
			}
		}
		constructor(nm,dev,col,ks,def) {
			super();
			this.name = nm;
			this.device = dev;
			this.color = col;
			this.keys = ks;
			this.deflt = def;
		}
		ready() {
			super.ready();
			let pii = this.shadowRoot.querySelector('paper-icon-item');
			//let pii = document.createElement('paper-icon-item');
			let ic1 = document.createElement('div');
			ic1.setAttribute('slot','item-icom');
			ic1.className = "avatar";
			//ic1.setAttribute('style','color: red;');
			//ic1.setAttribute('style','background-color: var('+this.color+');');
			let piidom = Polymer.dom(pii);
			piidom.appendChild(ic1);
			let pib = document.createElement('paper-item-body');
			let pibdom = Polymer.dom(pib);
			pib.setAttribute('two-line','');
			let l1 = document.createElement('div');
			l1.innerHTML = this.name;
			let l2 = document.createElement('div');
			l2.innerHTML = this.device;
			l2.setAttribute('secondary','');
			pibdom.appendChild(l1);
			pibdom.appendChild(l2);
			piidom.appendChild(pib);
			let ic2 = document.createElement('paper-icon-button');
			ic2.setAttribute('icon','star');
			if (this.deflt)
				ic2.className = 'defaultclass';
			else
				ic2.className = 'baseclass';
			piidom.appendChild(ic2);
		}

	}
	window.customElements.define(RemoteItem.is, RemoteItem);*/
	class ConnectionForm extends Polymer.Element {
		static get is() {
			return 'connection-form';
		}
		static get properties() {
			return {
				data: {
					type: Object,
					value: {},
					notify: true
				},
				hostErrorMessage: {
					type: String
				},
				portErrorMessage: {
					type: String
				},
				connectionError: {
					type: String
				},
				devicesList: {
					type: Array,
					value: []
				},
				AUTH_TOKEN: {
					type: String
				},
				USERNAME: {
					type: String
				}
			}
		}

		getAuthHeader(mime,dependency) {
			let header = {"Content-Type": mime, "Accept": mime, "Authorization": "Bearer "+this.AUTH_TOKEN};
			this.$.remotelist.set('AUTH_TOKEN',this.AUTH_TOKEN);
			console.log("new header CF "+JSON.stringify(header));
			return header;
		}

		submitform(event) {
			let dom = this.$;
			let that = this;
			const testbutton = dom.testbutton;
			const spinner = dom.testspinner;
			const optionssubmit = dom.optionssubmit;
			dom.submitajax.set('body', {
				'user': this.data,
				'actions': dom.remotelist.actions
			});
			let request = this.$.submitajax.generateRequest();
			return request.completes.then(function(req) {
				const resp = req.response;
				console.log("[submitform] request ok");
				console.log(resp);
				spinner.active = false;
				spinner.hidden = true;
				testbutton.disabled = false;
				optionssubmit.disabled = false;
				dom.remotelist.actions = {"renames":{},"raw":{},"filtered":{},"default":""};
				dom.remotelist.disable(false);
				//console.log(typeof resp);
				//eval(resp+'');

				return resp/*{
					"AUTH_TOKEN":AUTH_TOKEN,
					"USERNAME":USERNAME
				}*/;
			}).catch(function(err) {
				spinner.active = false;
				spinner.hidden = true;
				dom.remotelist.disable(false);
				RemoteList.checkErrRedir(err);
			});
		}

		ready() {
			super.ready();
			this.connectionError = "";
			//this.nameValidate();
			//let testList = [
				//{"idx":0,"devicenick":"fagiolo","remotenick":"sammy","name":"samsung","filtered":true,"device":"blackbeam1","default":true,"keys":[],"shs":[],"type":"r"},
				//{"idx":1,"devicenick":"fagiolo","remotenick":"murdoch","name":"sky","filtered":false,"device":"blackbeam1","default":false,"keys":[],"shs":[],"type":"r"}
			//];
			let dom = this.$;
			let that = this;
			let suf = dom.optionsform;
			let cl = function(event) {
				let v1 = dom.host.validate(),
					v2 = dom.port.validate();
				dom.optionssubmit.disabled = !(v1 && v2);
			}
			dom.host.addEventListener('input', cl);
			dom.port.addEventListener('input', cl);
			suf.addEventListener('change', cl);

			suf.addEventListener('iron-form-submit', function(event) {
				dom.testspinner.active = false;
				dom.testspinner.hidden = true;
				dom.optionssubmit.disabled = false;
				console.log("DETAIL ");
				console.log(event.detail);
			});

			suf.addEventListener('iron-form-presubmit', function() {
				//this.request.method = 'put';
				this.request.body['user'] = that.data;
				this.request.body['actions'] = that.$.remotelist.actions;
			});

			suf.addEventListener('iron-form-response', function(e) {
				const response = e.detail.response;
				//document.querySelector('.output').innerHTML = JSON.stringify(response, null, 2);
				console.log("RESP "+JSON.stringify(response, null, 2));
			});
			dom.connformlayout.responsiveSteps = [
				{minWidth: 0, columns: 1, labelsPosition: 'top'},
				{minWidth: '20em', columns: 3}
			];
			this.getAuthCode().then(function(datas) {
				that.set('AUTH_TOKEN',datas.AUTH_TOKEN);
				that.set('USERNAME',datas.USERNAME);
				console.log("getAuthCode OK "+JSON.stringify(datas))
				that.testConnection();
			}).catch(function (err) {
				console.log("[getauthcode] error");
				that.set('connectionError', "Auth Code request failed with code "+err.request.xhr.status);
				dom.optionsform.fire('change');
				RemoteList.checkErrRedir(err);
			});
		}
		getAuthCode() {
			let dom = this.$;
			const testbutton = dom.testbutton;
			const spinner = dom.testspinner;
			const optionssubmit = dom.optionssubmit;
			spinner.active = true;
			spinner.hidden = false;
			dom.remotelist.disable(true);
			testbutton.disabled = true;
			optionssubmit.disabled = true;
			let params = getUrlParameters();
			dom.authcodeajax.set('params', {
				"code": params.get('code'),
				"json": 1,
				"redirect_uri": '/options'
			});
			let request = dom.authcodeajax.generateRequest();
			return request.completes.then(function(req) {
				const resp = req.response;
				console.log("[getauthcode] request ok");
				console.log(resp);
				if (!resp)
					throw {"request": {"xhr": {"status": 1500}}};
				spinner.active = false;
				spinner.hidden = true;
				testbutton.disabled = false;
				optionssubmit.disabled = false;
				dom.remotelist.disable(false);
				//console.log(typeof resp);
				//eval(resp+'');

				return resp/*{
					"AUTH_TOKEN":AUTH_TOKEN,
					"USERNAME":USERNAME
				}*/;
			}).catch(function(err) {
				spinner.active = false;
				spinner.hidden = true;
				dom.remotelist.disable(false);
				throw err;
			});
		}

		setDataProperty(us) {
			this.set('data.host',us.options.orvhost);
			this.set('data.connected',us.connected);
			this.set('data.uid',us.uid);
			this.set('data.username',us.username);
			this.set('data.port',us.options.orvport);
			this.set('data.autologin',us.options.autologin);
			this.set('data.language',us.options.language);
		}
		setdevicesList(rList) {
			this.$.remotelist.splice('keysList',0,this.$.remotelist.keysList.length);
			this.$.remotelist.splice('remotesList',0,this.$.remotelist.remotesList.length);
			this.splice('devicesList',0,this.devicesList.length);
			this.set('devicesList',rList);
			this.$.remotelist.$.deviceslb.set('selected',-1);
			this.$.remotelist.$.deviceslb.set('selected',0);
		}

		testConnection(event) {
			const mainel = this;
			const dom = mainel.$;
			const optionsform = dom.optionsform;
			const testbutton = dom.testbutton;
			const spinner = dom.testspinner;
			const optionssubmit = dom.optionssubmit;
			spinner.active = true;
			spinner.hidden = false;
			testbutton.disabled = true;
			optionssubmit.disabled = true;
			dom.remotelist.disable(true);
			dom.host.disabled = true;
			dom.port.disabled = true;
			if (mainel.data['port']) {
				dom.optionsajax.set('params', {
					"host": mainel.data.host,
					"port": mainel.data.port
				});
			}
			console.log("[testcon] testing connection");
			let request = dom.optionsajax.generateRequest();
			request.completes.then(function(req) {
				const resp = req.response;
				console.log("jsonoptions request ok");
				console.log(resp);
				optionssubmit.disabled = false;
				//mainel.submit();
				spinner.active = false;
				testbutton.disabled = false;
				dom.host.disabled = false;
				dom.port.disabled = false;
				dom.remotelist.disable(false);
				let us;
				if (req.xhr.response && (us = req.xhr.response.user)) {
					mainel.setDataProperty(us);
					if (us.connected)
						dom.remotelist.createSiteConnection();
				}
				mainel.setdevicesList(req.xhr.response.devices);
			}, function(rejected) {
				console.log("[Rejected req]");
				let req = rejected.request;
				let error = rejected.error;
				let us;
				console.log(rejected);
				mainel.set('connectionError', "Request failed with code " + req.xhr.status);
				if (req.xhr.response && (us = req.xhr.response.user)) {
					console.log(JSON.stringify(us));
					mainel.setDataProperty(us);
					if (us.connected)
						dom.remotelist.createSiteConnection();
				}
				optionsform.fire('change');
				spinner.active = false;
				testbutton.disabled = false;
				dom.host.disabled = false;
				dom.port.disabled = false;
				dom.remotelist.disable(false);
				//signupform.querySelector('.output').innerHTML = errorMessage;
			});
		}
		/*submit() {
			let params = getUrlParameters();
			this.shadowRoot.querySelector('[name="redirect_uri"]').value = params.get('redirect_uri');
			this.shadowRoot.querySelector('[name="client_id"]').value = params.get('client_id');
			this.shadowRoot.querySelector('[name="redirect_uri"]').value = params.get('redirect_uri');
			this.shadowRoot.querySelector('[name="state"]').value = params.get('state');
			this.shadowRoot.querySelector('[name="username"]').value = this.shadowRoot.querySelector('paper-input[name="paper_username"]').value;
			this.shadowRoot.querySelector('[name="password"]').value = this.shadowRoot.querySelector('paper-input[name="paper_password"]').value;
			this.$.optionsforminner.submit();
		}*/
	}
	class RemoteList extends Polymer.Element {
		static get is() {
			return 'remote-list';
		}

		static get properties() {
			return {
				remotesList: {
					type: Array,
					value: [],
					notify: true
				},
				shLearn: {
					type: String,
					value: ''
				},
				learnDevice: {
					type: Object,
					value: {"device":"","remote":"","devicenick":"","remotenick":"","idx":-1,"type":""}
				},
				learnDialogList: {
					type: Array,
					value: [{'idx':0,'p0':'','p1':'','p2':'','last':true}]
				},
				learnDialogRemotesList: {
					type: Array,
					value: []
				},
				learnDialogElementsOk: {
					type: Boolean,
					value: false
				},
				shDialogElementsOk: {
					type: Boolean,
					value: false
				},
				devicesList: {
					type: Array,
					value: [],
					notify: true
				},
				keysList: {
					type: Array,
					value: [],
					notify: true
				},
				itemRename: {
					type: Object,
					value: {"device":"","remote":"","devicenick":"","remotenick":"","idx":-1,"type":"","raw":""},
					notify: true
				},
				itemRaw: {
					type: Object,
					value: {'raw':'','idx':-1,'remote':'','device':'','remotenick':'','devicenick':''},
					notify: true
				},
				currentES: {
					type: Object,
					value: null
				},
				disabled: {
					type: Boolean,
					value: false
				},
				connected: {
					type: Boolean,
					value: false
				},
				host: {
					type: String,
					value: 'localhost'
				},
				port: {
					type: String,
					value: '10001'
				},
				uid : {
					type: String,
					value: null
				},
				actions: {
					type: Object,
					value: {"renames":{},"raw":{},"filtered":{},"default":""}
				},
				AUTH_TOKEN: {
					type: String,
					value: ''
				},
				working: {
					type: Boolean,
					value: false,
					notify: true
				},
				COLORS: {
					type: Array,
					readOnly: true,
					value: [
						'--paper-red-300',
						'--paper-pink-100',
						'--paper-purple-200',
						'--paper-indigo-300',
						'--paper-blue-400',
						'--paper-light-blue-500',
						'--paper-cyan-500',
						'--paper-teal-a100',
						'--paper-green-600',
						'--paper-light-green-600',
						'--paper-lime-400',
						'--paper-yellow-700',
						'--paper-amber-600',
						'--paper-orange-700',
						'--paper-brown-500',
						'--paper-grey-500',
						'--paper-deep-orange-400',
						'--paper-deep-purple-800'
					]
				}
			}
		}

		createToast(style,msg,time) {
			let to = this.$.toastnotify;
			to.classList.remove('ok-toast');
			to.classList.remove('warn-toast');
			to.classList.remove('error-toast');
			to.classList.remove('plain-toast');
			to.classList.add(style+'-toast');
			to.text = msg;
			to.duration = time*1000;
			to.open();
		}

		manageES(detail) {
			console.log("Eccomi qua");
			let d = JSON.parse(detail.data);
			let msg = d.msg;
			let data = d.pld;
			let str = '';
			let tt = 5;
			console.log("New ES msg "+msg);
			if (msg=='conmsg') {
				str = data.msg;
			}
			else {
				let a = data.action;
				let devn = "N/A [N/A]";
				if (a.device && a.device.name && a.device.name.length>0) {
					devn = a.device.name+" ["+(a.device.type && a.device.type.length>6?a.device.type.substring(6):"N/A")+"]";
				}
				let cl = a.actionclass;
				if (cl=="ActionLearnir") {
					str = "Device "+devn+" learning key(s) "+JSON.stringify(a.irname);
				}
				else if (cl=="ActionNotifystate") {
					str = "Device "+devn+" notifying state "+(a.device.state?"on":"off");
				}
				else if (cl=="ActionIrask") {
					str = "Please press "+a.irname+" towards "+devn+" in 10 seconds.";
					tt = 7;
				}
				else if (cl=="ActionEmitir") {
					str = "Device "+devn+" emitting key(s) "+JSON.stringify(a.irname);
				}
				else if (cl.startsWith("ActionState")) {
					str = "Device "+devn+" switching "+(a.state?"on":"off");
				}
				else if (cl=="ActionPing")
					str = '';
				else if (cl=="ActionCreatesh") {
					str = "Device "+devn+" "+(a.irname.length>0?"creating":"deleting")+" shortcut "+a.shname;
				}
				else if (cl=="ActionDiscovery" || cl=="ActionGetinfo" || cl=="ActionDevicedl") {
					let o = cl!="ActionGetinfo"?a.hosts:a.discovery;
					let lstdev = [];
					Object.keys(o).forEach(function(key) {
						let d = o[key];
						lstdev.push(d.name+" ["+d.type.substring(6)+"/"+key+"]");
					});
					str = "Discovred "+lstdev.length+" devices: "+JSON.stringify(lstdev);
				}
				else
					str = "Action "+cl.substring(6)+" executed by device "+devn;

			}
			let tstyle = '';
			if (data.retval==1)
				tstyle = 'ok';
			else if (data.retval==null)
				tstyle = 'error';
			else if (data.retval>1)
				tstyle = 'warn';
			else
				tstyle = 'plain';
			if (str.length>0) {
				this.createToast(tstyle,str,tt);
			}
		}

		createSiteConnection() {
			if (!this.currentES) {
				this.currentES = new EventSource('/siteconnection/:'+this.uid);
				this.currentES.addEventListener('orvmsg',this.manageES.bind(this));
				this.currentES.addEventListener('conmsg',this.manageES.bind(this));
				this.currentES.onerror = (function(e) {
					this.currentES.close();
					this.currentES = null;
					this.createToast('error', 'Error in in the connection: retrying '+JSON.stringify(e.data),5);
					setTimeout(this.createSiteConnection.bind(this),10000);
				}).bind(this);
			}
		}

		shDialogNameInvalid(v,auto) {
			let el = this.$.shdialogInputShname;
			let oldinvalid = !el || el.invalid;
			let newinvalid = !v || v.length==0 || !/^@[a-zA-Z0-9\+\-_]+$/.exec(v);;
			if (typeof auto=="undefined" || auto)
				this.setShDialogElementsOk(newinvalid,oldinvalid);
			return newinvalid;
		}

		shDialogGetKeysListHidden(p1) {
			return p1=='$pause';
		}

		shDialogGetP2ComboInvalid(idx,p0,p1,p2,auto) {
			//console.log(this.shadowRoot.querySelector('#learndialog-input-p2-'+idx));
			let el = this.shadowRoot.querySelector('#shdialog-drop-p2-'+idx);
			let oldinvalid = !el || el.invalid;
			let newinvalid = !this.shDialogGetKeysListHidden(p1) && (!p2 || p2.length==0);
			if (typeof auto=="undefined" || auto)
				this.setShDialogElementsOk(newinvalid,oldinvalid);
			return newinvalid;
		}

		shDialogGetP1ComboInvalid(idx,p0,p1,p2,auto) {
			//console.log(this.shadowRoot.querySelector('#learndialog-input-p0-'+idx));
			let el = this.shadowRoot.querySelector('#shdialog-drop-p1-'+idx);
			let oldinvalid = !el || el.invalid;
			let newinvalid = !p1 || p1.length==0;
			if (typeof auto=="undefined" || auto)
				this.setShDialogElementsOk(newinvalid,oldinvalid);
			return newinvalid;
		}

		getShDialogKeysList(p1) {
			if (p1!='$pause') {
				let out = [];
				this.learnDialogRemotesList.some(function(rem) {
					if (rem.remote==p1) {
						out = rem.items.slice(0);
						return true;
					}
					else
						return false;
				});
				return out;

			}
			else
				return [];
		}

		pxInputFieldInvalid(px) {
			return !px || px.length==0 || !/^[a-zA-Z0-9\+\-_]+$/.exec(px);
		}

		learnDialogGetP2InputInvalid(idx,p0,p1,p2,auto) {
			//console.log(this.shadowRoot.querySelector('#learndialog-input-p2-'+idx));
			let el = this.shadowRoot.querySelector('#learndialog-input-p2-'+idx);
			let oldinvalid = !el || el.invalid;
			let newinvalid = this.pxInputFieldInvalid(p2);
			if (typeof auto=="undefined" || auto)
				this.setLearnDialogElementsOk(newinvalid,oldinvalid);
			return newinvalid;
		}

		learnDialogGetP1ComboInvalid(idx,p0,p1,p2,auto) {
			//console.log(this.shadowRoot.querySelector('#learndialog-input-p0-'+idx));
			let el = this.shadowRoot.querySelector('#learndialog-drop-p1-'+idx);
			let oldinvalid = !el || el.invalid;
			let newinvalid = !p1 || p1.length==0;
			if (typeof auto=="undefined" || auto)
				this.setLearnDialogElementsOk(newinvalid,oldinvalid);
			return newinvalid;
		}

		learnDialogGetP0InputInvalid(idx,p0,p1,p2,auto) {
			//console.log(this.shadowRoot.querySelector('#learndialog-input-p0-'+idx));
			let el = this.shadowRoot.querySelector('#learndialog-input-p0-'+idx);
			let oldinvalid = !el || el.invalid;
			let newinvalid = !this.learnDialogGetP0InputDisabled(idx,p0,p1,p2) && this.pxInputFieldInvalid(p0);
			if (typeof auto=="undefined" || auto)
				this.setLearnDialogElementsOk(newinvalid,oldinvalid);
			return newinvalid;
		}

		shDialogGetP0InputInvalid(idx,p0,p1,p2,auto) {
			//console.log(this.shadowRoot.querySelector('#learndialog-input-p0-'+idx));
			let el = this.shadowRoot.querySelector('#shdialog-input-p0-'+idx);
			let oldinvalid = !el || el.invalid;
			let newinvalid = this.shDialogGetKeysListHidden(p1) && !(parseFloat(p0)>0.0);
			if (typeof auto=="undefined" || auto)
				this.setShDialogElementsOk(newinvalid,oldinvalid);
			return newinvalid;
		}

		learnDialogGetP0InputDisabled(idx,p0,p1,p2) {
			return p1!='new';
		}

		learnDialogRowInvalid(el) {
			return this.learnDialogGetP1ComboInvalid(el.idx,el.p0,el.p1,el.p2,false) || this.learnDialogGetP0InputInvalid(el.idx,el.p0,el.p1,el.p2,false) || this.learnDialogGetP2InputInvalid(el.idx,el.p0,el.p1,el.p2,false);
		}

		shDialogRowInvalid(el) {
			return this.shDialogGetP1ComboInvalid(el.idx,el.p0,el.p1,el.p2,false) || this.shDialogGetP2ComboInvalid(el.idx,el.p0,el.p1,el.p2,false) || this.shDialogGetP0InputInvalid(el.idx,el.p0,el.p1,el.p2,false);
		}

		setLearnDialogElementsOk(newinvalid,oldinvalid) {
			if (newinvalid!=oldinvalid) {
				if (newinvalid)
					this.set('learnDialogElementsOk',false);
				else {
					this.set('learnDialogElementsOk',!this.learnDialogList.some((function(el) {
						if (this.learnDialogRowInvalid(el))
							return true;
						else
							return false;
					}).bind(this)));
				}
			}
		}

		setShDialogElementsOk(newinvalid,oldinvalid) {
			if (newinvalid!=oldinvalid) {
				if (newinvalid || this.shDialogNameInvalid(this.shLearn,false))
					this.set('shDialogElementsOk',false);
				else {
					this.set('shDialogElementsOk',!this.learnDialogList.some((function(el) {
						if (this.shDialogRowInvalid(el))
							return true;
						else
							return false;
					}).bind(this)));
				}
			}
		}

		learnDialogGetAddButtonDisabled(idx,p0,p1,p2,last) {
			return this.learnDialogRowInvalid({'idx': idx,'p0':p0,'p1':p1,'p2':p2,'last':last});
		}

		shDialogGetAddButtonDisabled(idx,p0,p1,p2,last) {
			return this.shDialogRowInvalid({'idx': idx,'p0':p0,'p1':p1,'p2':p2,'last':last});
		}

		learnDialogGetAddButtonHidden(idx,p0,p1,p2,last) {
			return !last;
		}

		learnDialogRemoveLine(event) {
			let el = event.model.item;
			if (el.last) {
				this.set('learnDialogList.'+(this.learnDialogList.length-2)+'.last' ,true);
			}
			this.splice('learnDialogList',el.idx,1);
			this.learnDialogList.forEach(function(it,idx) {
				it.idx = idx;
			});
		}

		learnDialogGetRemoveButtonDisabled(idx,p0,p1,p2,last) {
			return idx==0 && last;
		}

		manageAjaxRequest(request,txt,dlg) {
			let mainel = this;
			mainel.setWorking(true);
			request.completes.then(function(req) {
				const resp = req.response;
				console.log('['+txt+" ajax] request ok");
				console.log(resp);
				mainel.setWorking(false);
				let rv = req.xhr.response.exitv;
				if (rv==0)
					mainel.createToast('ok',txt+' request sent successfully',3);
				else
					mainel.createToast('warn',txt+' request sending error '+rv,3);
				if (dlg)
					dlg.close();
			}, function(rejected) {
				console.log('['+txt+" ajax] request Rejected");
				console.log(rejected);
				mainel.setWorking(false);
				RemoteList.checkErrRedir(rejected);
			});
		}

		learnKeysDo(event) {
			if (this.uid && this.currentES) {
				let lstlearn = [];
				this.learnDialogList.forEach(function(el) {
					let remote;
					if (el.p1=="new")
						remote = el.p0;
					else
						remote = el.p1;
					lstlearn.push(remote+':'+el.p2);
				});
				this.$.serviceajax.url = '/learnkey';
				this.$.serviceajax.method = 'POST';
				this.$.serviceajax.set('body', {
					"device": this.learnDevice.device,
					"lst": lstlearn
				});
				let request = this.$.serviceajax.generateRequest();
				this.manageAjaxRequest(request,"Learn",this.$.learndialog);
			}
		}

		createShDo(event) {
			if (this.uid && this.currentES) {
				let lstsh = [];
				this.learnDialogList.forEach(function(el) {
					let key;
					if (el.p1=="$pause")
						key = '$'+el.p0;
					else
						key = el.p1+':'+el.p2;
					lstsh.push(key);
				});
				this.$.serviceajax.url = '/createsh';
				this.$.serviceajax.method = 'POST';
				this.$.serviceajax.set('body', {
					"device": this.learnDevice.device,
					"name": this.shLearn,
					"lst": lstsh
				});
				let request = this.$.serviceajax.generateRequest();
				this.manageAjaxRequest(request,"CreateSh",this.$.shdialog);
			}
		}

		learnDialogAddLine(event) {
			let fromv = this.learnDialogList[this.learnDialogList.length-1];
			this.push('learnDialogList',{'p0':fromv.p0,'p1':fromv.p1,'p2':'','idx':fromv.idx+1,'last':true});
			this.set('learnDialogList.'+(this.learnDialogList.length-2)+'.last' ,false);
		}

		shDialogAddLine(event) {
			let fromv = event.model.item;
			this.splice('learnDialogList',fromv.idx+1,0,{'p0':fromv.p0,'p1':fromv.p1,'p2':fromv.p2,'idx':fromv.idx+1,'last':fromv.idx==this.learnDialogList.length-1});
			for (let i = 0;i<=fromv.idx; i++)
				this.set('learnDialogList.'+i+'.last' ,false);
			for (let i = fromv.idx+2;i<this.learnDialogList.length; i++)
				this.set('learnDialogList.'+i+'.idx' ,i);

		}

		disable(v) {
			console.log("remotelist disabled "+v);
			this.set('disabled',v);
		}

		setWorking(v) {
			console.log("remotelist disabled "+v);
			this.set('working',v);
			this.set('disabled',v);
		}

		getAuthHeader(mime,dependency) {
			let header = {"Content-Type": mime, "Accept": mime, "Authorization": "Bearer "+this.AUTH_TOKEN};
			console.log("new header RL "+JSON.stringify(header));
			return header;
		}

		getRemoteColor(item) {
			//console.log("getRemoteColor "+JSON.stringify(item));
			return "background-color: var("+this.COLORS[item.idx%this.COLORS.length]+");";
		}

		getDefaultRemoteClass(item,def) {
			//console.log("getDefaultRemoteClass "+JSON.stringify(item));
			return item.default?"defaultclass":"baseclass";
		}

		getDefaultRemoteButtonDisabled(item,type) {
			return item.type!="r1" || this.disabled;
		}

		getRenameRemoteButtonDisabled(item,type) {
			return item.type!="r1" || this.disabled;
		}

		getRenameKeyButtonDisabled(item,type) {
			return this.disabled;
		}

		getRenameDeviceInputDisabled(idx,type) {
			return type.length==0 || this.disabled;
		}

		getRenameRemoteInputDisabled(idx,type) {
			return type.length==0 || type.charAt(0)=="d" || type=="r2" || type=="r3" || this.disabled;
		}

		getDeviceNameInvalid(v,type) {
			return !/^[0-9a-zA-Z \-\+&]+$/.exec(v);
		}

		getRemoteNameInvalid(v,type) {
			return !/^[0-9a-zA-Z \-\+&]+$/.exec(v) && !this.getRenameRemoteInputDisabled(0,type);
		}

		getRenameF1Label(tp) {
			if (tp.startsWith("d") || tp.startsWith("r") || tp=="k3")
				return "Device Name";
			else
				return "Remote Name";
		}

		getRenameF2Label(tp) {
			if (tp.startsWith("d") || tp.startsWith("r"))
				return "Remote Name";
			else if (tp=="k3")
				return "Action Name";
			else
				return "Key Name";
		}

		getRenameButtonDisabled(idx,device,remote,type) {
			return this.getRemoteNameInvalid(remote,type) || this.getDeviceNameInvalid(device,type);
		}

		getSelectedRemoteButtonDisabled(item,type) {
			return item.type=="r2" || this.disabled;
		}

		setDefaultRemote(event) {
			let el = event.model.item;
			if (!el.default) {
				let that = this;
				that.devicesList.some(function(dev) {
					if (dev.items) {
						return dev.items.some(function(rem) {
							if (rem.default) {
								if (dev.items!=that.remotesList)
									rem.default = false;
								else
									this.set('remotesList.'+rem.idx+'.default', false);
								return true;
							}
							else
								return false;
						});
					}
					else
						return false;
				});
				let remelem = that.remotesList[el.idx];
				this.set('remotesList.'+el.idx+'.default', true);
				that.actions.default = remelem.device+':'+remelem.remote;
			}
		}

		setItemRename(event) {
			let el = event.model.item;
			this.set('itemRename.devicenick',el.devicenick);
			this.set('itemRename.remotenick',el.remotenick);
			this.set('itemRename.device',el.device);
			this.set('itemRename.remote',el.remote);
			this.set('itemRename.idx',el.idx);
			this.set('itemRename.type',el.type);
			this.set('itemRename.raw',el.raw);
			//console.log(event.composedPath()[0]);
			//console.log(event.target);
			this.$.renamedialog.positionTarget = event.composedPath()[0];
			this.$.renamedialog.open();
		}

		onDeviceSelected(event) {
			let sel = this.$.deviceslb.selected;
			this.$.keyslb.selected = 0;
			this.$.remoteslb.selected = 0;
			this.set('keysList',[]);
			if (sel>=0 && sel<this.devicesList.length) {
				this.set('remotesList',this.devicesList[sel].items);
				this.onRemoteSelected(null);
			}
			else {
				this.set('remotesList',[]);
			}
		}

		onRemoteSelected(event) {
			let sel = this.$.remoteslb.selected;
			console.log("Changesel remote "+sel);
			this.$.keyslb.selected = 0;
			if (sel>=0 && sel<this.remotesList.length) {
				this.set('keysList',this.remotesList[sel].items);
				this.onKeySelected(null);
			}
			else {
				this.set('keysList',[]);
			}
		}

		onKeySelected(event) {
			let sel = this.$.keyslb.selected;
			console.log("Changesel key "+sel);
			if (this.keysList && sel>=0 && sel<this.keysList.length) {
				this.set('itemRaw',Object.assign({},this.keysList[sel]));
			}
			else {
				this.set('itemRaw',{'raw':'','idx':-1,'remote':'','device':'','remotenick':'','devicenick':''});
			}
		}

		getRawDevClass(tp) {
			return (tp!="k1" && tp!="k2")?"hidden":"";
		}

		setRawKeyInputOK(event) {
			let idx = this.itemRename.idx;
			if (idx>=0 && idx<this.keysList.length) {
				this.keysList[idx].raw = this.itemRename.raw;
				let key = this.remotesList[this.$.remoteslb.selected].device+':'+
					this.itemRename.device+':'+
					this.itemRename.remote;
				this.actions.raw[key] = this.itemRename.raw;
				console.log("Action inserted: "+key);
				this.createToast('plain','Edit action will be executed on submit',5);
			}
		}

		setRawKeyInputCancel(event) {
			let idx = this.itemRename.idx;
			if (idx>=0 && idx<this.keysList.length) {
				this.set('itemRename.raw',this.keysList[idx].raw);
			}
		}

		getRawKeyInputDisabled(raw,type) {
			return raw!=null && raw.length>0 && /[^0-9,]/.exec(raw) && type=="k1";
		}

		setRenameDevice(event) {
			this.setItemRename(event);
		}

		setRenameRemote(event) {
			this.setItemRename(event);
		}

		setRenameKey(event) {
			this.setItemRename(event);
		}

		getLearnKeyButtonDisabled(item,type,connected) {
			return !connected || (!type.startsWith("dr") && type!="r1" && type!="r2" && type!="k1" && type!="k2");
		}

		getEmitKeyButtonDisabled(item,type,connected) {
			return !connected || (type!="k3" && type!="k1" && type!="k2");
		}

		setLearnKeyRemote(event) {
			let el = event.model.item;
			if (this.learnDialogList.length>1) {
				this.splice('learnDialogList',1,this.learnDialogList.length-1);
			}
			if (el.type=="r2" || el.type=="k2") {
				this.set('learnDevice',this.devicesList[this.$.deviceslb.selected]);
				let reml = this.devicesList[this.$.deviceslb.selected].items.slice(0);
				reml.push({
					'raw':'',
					'remote':'$pause',
					'device':this.learnDevice.device,
					'remotenick':'$pause',
					'devicenick':this.learnDevice.devicenick,
					'idx':reml.length,
					'type':'k4',
					'default':false,
					'filtered':false});
				this.set('learnDialogRemotesList',reml);
				if (el.type.charAt(0)=="r") {
					this.set('shLearn','');
					this.set('learnDialogList.0.last',true);
					this.set('learnDialogList.0.idx',0);
					this.set('learnDialogList.0.p0','');
					this.set('learnDialogList.0.p1','');
					this.set('learnDialogList.0.p2','');
				}
				else {
					this.set('shLearn',el.remote);
					let keys = el.raw.split('|');
					this.splice('learnDialogList',1,1);
					keys.forEach(function(key,idx) {
						let p1v = '',p2v = '',p0v = '',spli;
						if (key.charAt(0)=='@') {
							p1v = this.learnDialogRemotesList[this.learnDialogRemotesList.length-2].remote;
							p2v = el.remote;
						}
						else if (key.charAt(0)=='$') {
							p1v = this.learnDialogRemotesList[this.learnDialogRemotesList.length-1].remote;
							p0v = key.substring(1);
						}
						else if ((spli = key.indexOf(':'))>0 && spli+1<key.length-1) {
							p1v = key.substring(0,spli);
							p2v = key.substring(spli+1);
						}
						if (!idx) {
							this.set('learnDialogList.0.last',idx==keys.length-1);
							this.set('learnDialogList.0.idx',0);
							this.set('learnDialogList.0.p0',p0v);
							this.set('learnDialogList.0.p1',p1v);
							this.set('learnDialogList.0.p2',p2v);
						}
						else
							this.push('learnDialogList',{
								'p0':p0v,
								'p1':p1v,
								'p2':p2v,
								'last':idx==keys.length-1,
								'idx':idx
							});
					},this);
				}
				this.$.shdialog.open();
			}
			else {
				this.set('learnDialogList.0.last',true);
				this.set('learnDialogList.0.idx',0);
				this.set('learnDialogList.0.p0','');
				this.set('learnDialogList.0.p1','');
				this.set('learnDialogList.0.p2','');
				let reml,rems;
				if (el.type.charAt(0)=="d") {
					this.set('learnDevice',el);
					reml = el.items.slice(0,el.items.length-1);
					rems = '';
				}
				else {
					this.set('learnDevice',this.devicesList[this.$.deviceslb.selected]);
					reml = this.remotesList.slice(0,this.remotesList.length-1);
					if (el.type.charAt(0)=="k") {
						rems = this.remotesList[this.$.remoteslb.selected].remote;
						this.set('learnDialogList.0.p2',el.remote);
					}
					else
						rems = this.remotesList[el.idx].remote;
				}
				reml.push({'raw':'','idx':reml.length,'remote':'new','device':this.learnDevice.device,'remotenick':'new','devicenick':this.learnDevice.devicenick});
				this.set('learnDialogRemotesList',reml);
				this.set('learnDialogList.0.p1',rems);
				this.$.learndialog.open();
			}
		}

		emitKeyDo(event) {
			if (this.uid && this.currentES) {
				let el = event.model.item;
				this.$.serviceajax.url = '/emitkey';
				this.$.serviceajax.method = 'GET';
				this.$.serviceajax.set('params', {
					"device": this.devicesList[this.$.deviceslb.selected].device,
					"remote": this.remotesList[this.$.remoteslb.selected].remote,
					"key":el.remote,
					"type":el.type
				});
				let request = this.$.serviceajax.generateRequest();
				this.manageAjaxRequest(request,"Emit",null);
			}
		}

		static checkErrRedir(err) {
			console.log(err);
			console.log("[ERROROUT] "+JSON.stringify(err.request.xhr.response));
			let loc = err.request.xhr.response && err.request.xhr.response.redir?err.request.xhr.response.redir:'/login';
			window.location = loc;
			window.history.pushState({}, null, loc);
			window.dispatchEvent(new CustomEvent('location-changed'));
		}

		getDRKListClass(lst) {
			return !lst || lst.length==0?"hidden":"";
		}

		getDeviceIcon(item,tp) {
			if (tp.startsWith("ds"))
				return "device:usb";
			else if (tp.startsWith("dr"))
				return "icons:settings-remote";
		}

		setSelectedRemote(event) {
			let el = event.model.item;
			let v = !el.filtered;
			let that = this;
			let remsel = that.remotesList[el.idx];
			that.set('remotesList.'+el.idx+'.filtered', v);
			that.actions.filtered[remsel.device+':'+remsel.remote] = v;
			that.remotesList[el.idx].items.forEach(function(key) {
				if (that.keysList==that.remotesList[el.idx].items)
					that.set('keysList.'+key.idx+'.filtered', v);
				else
					key.filtered = v;
			});
			if (remsel.type!="r3") {
				let shofdevice = that.remotesList[that.remotesList.length-1].items;
				shofdevice.forEach(function(sh,idx) {
					sh.filtered = true;
					Object.keys(sh.items).some(function(foundremote) {
						for (let i = 0; i<that.remotesList.length-1; i++) {
							let rem = that.remotesList[i];
							if (rem.remote==foundremote) {
								if (!rem.filtered)
									sh.filtered = false;
								break;
							}
						}
						return !sh.filtered;
					});
					if (that.keysList==shofdevice)
						that.set('keysList.'+idx+'.filtered', sh.filtered);
				});
			}
		}

		getSelectedRemoteIcon(item,filtered) {
			return "icons:radio-button-"+(filtered?"":"un")+"checked";
		}

		getSelectedKeyIcon(item,filtered) {
			return this.getSelectedRemoteIcon(item,filtered);
		}

		renameAll() {
			let idx = this.itemRename.idx;
			if (idx>=0) {
				let orig = null;
				if (this.itemRename.type.startsWith('d'))
					orig = this.devicesList[idx];
				else if (this.itemRename.type.startsWith('r'))
					orig = this.remotesList[idx];
				else if (this.itemRename.type.startsWith('k'))
					orig = this.keysList[idx];
				if (orig) {
					let that = this;
					let performRename = function(nmfrom,nmnick,lst,lstname) {
						lst.forEach(function (el,i) {
							if (el.device==nmfrom) {
								if (lstname.length>0)
									that.set(lstname+'.'+i+'.devicenick', nmnick);
								else
									el.devicenick = nmnick;
							}
							if (el.remote==nmfrom) {
								if (lstname.length>0)
									that.set(lstname+'.'+i+'.remotenick', nmnick);
								else
									el.remotenick = nmnick;
							}
						});
					}
					let lstRename = [
						{"lst":that.devicesList,"lstname":"devicesList"},
						{"lst":that.remotesList,"lstname":"remotesList"},
						{"lst":that.keysList,"lstname":"keysList"},];
					that.devicesList.forEach(function(dev) {
						if (dev.items) {
							if (dev.items!=that.remoteList)
								lstRename.push({"lst":dev.items,"lstname":""});
							dev.items.forEach(function(rem) {
								if (rem.items!=that.keysList) {
									lstRename.push({"lst":rem.items,"lstname":""});
								}
							});
						}
					});

					if (this.itemRename.devicenick!=orig.devicenick) {
						lstRename.forEach(function(renItem) {
							performRename(orig.device,this.itemRename.devicenick,renItem.lst,renItem.lstname);
						},this);

						this.actions.renames[orig.device] = this.itemRename.devicenick;
						this.createToast('plain','Translation add of "'+orig.device+'" to "'+this.itemRename.devicenick+'" will be done on submit',5);
					}
					if (this.itemRename.remotenick!=orig.remotenick) {
						lstRename.forEach(function(renItem) {
							performRename(orig.remote,this.itemRename.remotenick,renItem.lst,renItem.lstname);
						},this);
						this.actions.renames[orig.remote] = this.itemRename.remotenick;
						this.createToast('plain','Translation add of "'+orig.remote+'" to "'+this.itemRename.remotenick+'" will be done on submit',5);
					}
				}
			}
		}

		ready() {
			super.ready();
			this.$.deviceslayout.responsiveSteps = [
				{minWidth: 0, columns: 1, labelsPosition: 'top'},
				{minWidth: '20em', columns: 3}
			];
			/*this.addEventListener('on-elements-list-changed', function(event) {
				console.log("AAAAAAAAA");
			});*/
		}

		/*ready() {
			super.ready();
			let pl = Polymer.dom(this.shadowRoot.querySelector('paper-listbox'));
			for (let i = 0; i<this.elementsList.length; i++) {
				let el = this.elementsList[i];
				let listitem = new RemoteItem(el.name,el.device,this.COLORS[i%this.COLORS.length],el.default,el.keys);
				pl.appendChild(listitem);
				//listitem.name = el.name;
				//listitem.device = el.device;
				//listitem.deflt = el.default;
				//listitem.keys = el.keys;
				//listitem.color = this.COLORS[i%this.COLORS.length];
			}
		}*/

	}
	window.customElements.define(RemoteList.is, RemoteList);
	window.customElements.define(ConnectionForm.is, ConnectionForm);
	window.customElements.define(ConnectionValidator.is, ConnectionValidator);
	/*const signupform = document.getElementById('signupform');
	const signupsubmit = document.getElementById('signupsubmit');
	const spinner = document.getElementById('spinner');*/

});
</script>

</head>

<body>
<connection-form></connection-form>
</body>
