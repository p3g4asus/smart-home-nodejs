<!--
@license
Copyright 2017, Google, Inc.
Licensed under the Apache License, Version 2.0 (the 'License');
you may not use this file except in compliance with the License.
You may obtain a copy of the License at
    http://www.apache.org/licenses/LICENSE-2.0
Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an 'AS IS' BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.
-->

<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, minimum-scale=1, initial-scale=1, user-scalable=yes">

    <title>Smart Home Provider</title>
    <meta name="description" content="Smart Home virtual devices">

    <link rel="icon" href="images/favicon.ico">

    <!-- See https://goo.gl/OOhYW5 for web app manifests -->
    <link rel="manifest" href="manifest.json">

    <!-- See https://goo.gl/qRE0vM for Chrome on Android theme-color attribute -->
    <meta name="theme-color" content="#3f51b5">

    <!-- Add to homescreen for Chrome on Android. Fallback for manifest.json -->
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="application-name" content="Smart Home Gizmos">

    <!-- Add to homescreen for Safari on iOS -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Smart Home Gizmos">

    <!-- Homescreen icons -->
    <link rel="apple-touch-icon" href="images/manifest/icon-48x48.png">
    <link rel="apple-touch-icon" sizes="72x72" href="images/manifest/icon-72x72.png">
    <link rel="apple-touch-icon" sizes="96x96" href="images/manifest/icon-96x96.png">
    <link rel="apple-touch-icon" sizes="144x144" href="images/manifest/icon-144x144.png">
    <link rel="apple-touch-icon" sizes="192x192" href="images/manifest/icon-192x192.png">

    <!-- Tile icon for Windows 8 (144x144 + tile color) -->
    <meta name="msapplication-TileImage" content="images/manifest/icon-144x144.png">
    <meta name="msapplication-TileColor" content="#3f51b5">
    <meta name="msapplication-tap-highlight" content="no">

    <!-- login -->
    <meta name="google-signin-scope" content="profile email">
    <script src="bower_components/webcomponentsjs/webcomponents-lite.js"></script>
    <script>
        const SMART_HOME_PROVIDER_CLOUD_ENDPOINT = '/smart-home-api';

        // Setup Polymer options
        window.Polymer = {
            dom: 'shadow',
            lazyRegister: true
        };

        // Load webcomponentsjs polyfill if browser does not support native Web Components
        (function() {
            'use strict';

            var onload = function() {
                // For native Imports, manually fire WebComponentsReady so user code
                // can use the same code path for native and polyfill'd imports.
                if (!window.HTMLImports) {
                    document.dispatchEvent(
                        new CustomEvent('WebComponentsReady', {
                            bubbles: true
                        })
                    );
                }
            };

            var webComponentsSupported = (
                'registerElement' in document &&
                'import' in document.createElement('link') &&
                'content' in document.createElement('template')
            );

            if (!webComponentsSupported) {
                var script = document.createElement('script');
                script.async = true;
                script.src = 'bower_components/webcomponentsjs/webcomponents-lite.js';
                script.onload = onload;
                document.head.appendChild(script);
            } else {
                onload();
            }
        })();

        // Load pre-caching Service Worker
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', function() {
                navigator.serviceWorker.register('service-worker.js');
            });
        }
    </script>

    <link rel="import" href="bower_components/polymer/polymer.html">
    <link rel="import" href="bower_components/app-layout/app-header/app-header.html">
    <link rel="import" href="bower_components/app-layout/app-scroll-effects/app-scroll-effects.html">
    <link rel="import" href="bower_components/app-layout/app-toolbar/app-toolbar.html">
    <link rel="import" href="bower_components/iron-form/iron-form.html">
    <link rel="import" href="bower_components/iron-icon/iron-icon.html">
    <link rel="import" href="bower_components/iron-icons/iron-icons.html">
    <link rel="import" href="bower_components/iron-icons/communication-icons.html">
    <link rel="import" href="bower_components/iron-icons/social-icons.html">
    <link rel="import" href="bower_components/iron-list/iron-list.html">
    <link rel="import" href="bower_components/paper-dialog/paper-dialog.html">
    <link rel="import" href="bower_components/paper-input/paper-input.html">
    <link rel="import" href="bower_components/paper-button/paper-button.html">
    <link rel="import" href="bower_components/paper-icon-button/paper-icon-button.html">
    <link rel="import" href="bower_components/paper-toast/paper-toast.html">

    <style>
        body {
            margin: 0;
            font-family: 'Roboto', 'Noto', sans-serif;
            line-height: 1.5;
            min-height: 100vh;
            background-color: #eeeeee;
        }
    </style>
</head>

<body>
    <style>
        app-header {
            color: #fff;
            background-color: #4285f4;
        }

        app-header paper-icon-button {
            --paper-icon-button-ink-color: white;
        }
    </style>

    <dom-module id="signup-form">
        <template>
        <style>

            div.main {
                margin-left: auto;
                margin-right: auto;
                text-align: center;
                width: 100%;
            }

            div.main > h1 {
                color: #333;
            }

            paper-input {
                width: calc(100% - 40px);
                margin-left: 20px;
                text-align: left;
                margin-bottom: 20px;
            }

            paper-input iron-icon {
                margin-right: 16px;
                color: #555;
            }

            paper-button {
                color: white;
                background-color: #4285f4;
            }

            @media (max-width:800px) {
                div.main > h1 {
                    font-size: 16pt;
                }
            }

            @media (min-width:800px) {
                div.main {
                    width: 600px;
                }
                paper-input {
                    margin-left: 80px;
                }
            }
            paper-button[disabled] {
                background-color: #eadbd8;
                color: #4285f4;
            }
        </style>
        <div class='main'>
        <h1>Link your devices to Google</h1>
        <img src='images/assistant-small.png' />
        <iron-form id="signupform" allow-redirects="true">
        <form action='/signup' method='post' id="signupforminner">
        <password-validator
           error-message={{passwordErrorMessage}} >
        </password-validator>
        
        <equality-validator
           check-equal-to={{data.password}}>
        </equality-validator>
        
        <username-validator
           error-message={{usernameErrorMessage}}
           already-taken=[[usernameTaken]]>
        </username-validator>
        <iron-ajax
            id="usernamecheck"
            url="/checkuser"
            handle-as="json"
			reject-with-request="true"
            debounce-duration="300"></iron-ajax>
        <paper-input
            label="Username"
            id="username"
            value={{data.username}} 
            error-message=[[usernameErrorMessage]]
            name="paper_username"
            validator="username-validator">
            <iron-icon icon="social:person" prefix></iron-icon>
        </paper-input>
        <!--<paper-input
            label="Username"
            id="username"
            value={{data.username}} 
            name="paper_username"
            psttern="[0-9a-zA-Z_\-]+"
            required
            auto-validate>
            <iron-icon icon="social:person" prefix></iron-icon>
        </paper-input>-->
        
        <paper-input 
            label="Password" 
            value={{data.password}} 
            error-message=[[passwordErrorMessage]]
            type="password"
            id="password"
            name="paper_password"
            validator="password-validator">
            <iron-icon icon="communication:vpn-key" prefix></iron-icon>
        </paper-input>  
        <paper-input
            label="Repeat Password"
            error-message="Passwords do not match"
            value=[[data.repeat_password]]
            type="password"
            id="repeat_password"
            name="repeat_paper_password"
            validator="equality-validator">
            <iron-icon icon="communication:vpn-key" prefix></iron-icon>
        </paper-input>
        <paper-button raised onclick="_submit(event)" disabled id="signupsubmit">
            <paper-spinner id="spinner" hidden></paper-spinner>
            Submit
        </paper-button>
        <input type="hidden" name="redirect" />
        <input type="hidden" name="client_id" />
        <input type="hidden" name="redirect_uri" />
        <input type="hidden" name="state" />
        <input type="hidden" name="username" />
        <input type="hidden" name="password" />
        <paper-button raised onclick="_reset(event)">Reset</paper-button>
        <pre class="output"></pre>
        </form>
        </iron-form>
        </div>
    </template>
    </dom-module>

    <app-header condenses reveals effects="waterfall">
        <app-toolbar>
            <paper-icon-button icon="home"></paper-icon-button>
            <div main-title>Smart Home Provider</div>
            <div>Welcome</div>
        </app-toolbar>
    </app-header>


    <signup-form></signup-form>
    <!--<h1>Link your devices to Google</h1>
        <img src='images/assistant-small.png' />
        <iron-form  id='signupform'>
        <form action='/signup' method='post' is='iron-form'>
            <paper-input label="Username" id="username" name="paper_username" allowed-pattern="[a-zA-Z_\-]" required auto-validate>
                <iron-icon icon="social:person" prefix></iron-icon>
            </paper-input>
            <password-validator></password-validator>           
            <paper-input label="Password" type="password" id="password" name="paper_password"  validator="password-validator" auto-validate>
                <iron-icon icon="communication:vpn-key" prefix></iron-icon>
            </paper-input>  
            <paper-input label="Password" type="password" id="repeat_password" name="repeat_paper_password" validator="equality-validator" auto-validate>
                <iron-icon icon="communication:vpn-key" prefix></iron-icon>
            </paper-input>

            <input type="hidden" name="redirect">
            <input type="hidden" name="client_id">
            <input type="hidden" name="redirect_uri">
            <input type="hidden" name="state" />
            <input type="hidden" name="username">
            <input type="hidden" name="password" />

            <paper-button raised onclick="formSubmit()">Signup</paper-button>
            <paper-button raised onclick="_submit(event)" disabled id="signupsubmit">
                <paper-spinner id="spinner" hidden></paper-spinner>
                Submit
            </paper-button>
            <paper-button raised onclick="_reset(event)">Reset</paper-button>           
            <pre class="output"></pre>
        </form>
        </iron-form>-->

<script>
function getUrlParameters() {
	// Get each parameter
	let query = window.location.search.substr(1);
	// Split each parameter into a key-value pair
	let keyValues = query.split('&');
	let parameterMap = new Map();
	for (let i in keyValues) {
		// Split into <key>=<value>
		let param = keyValues[i];
		let splitParam = param.split('=');
		parameterMap.set(splitParam[0], splitParam[1]);
	}
	return parameterMap;
}

function _submit(event) {
	const mainel = document.querySelector('signup-form');
	const dom = mainel.$;
	const signupform = dom.signupform;
	const spinner = dom.spinner;
	const signupsubmit = dom.signupsubmit;
	spinner.active = true;
	spinner.hidden = false;
	signupsubmit.disabled = true;
	dom.usernamecheck.set('params', {
		"us": mainel.data.username
	});
	let request = dom.usernamecheck.generateRequest();
	request.completes.then(function(req) {
		console.log("[Completes req]");
		mainel.submit();
	}, function(rejected) {
		console.log("[Rejected req]");
		let req = rejected.request;
		let error = rejected.error;
		console.log(JSON.stringify(rejected));
		if (error == 406)
			mainel.usernameTaken = "Username is already taken.";
		else
			mainel.usernameTaken = "Request failed with code " + req.xhr.status;
		signupform.fire('change');
		//signupform.querySelector('.output').innerHTML = errorMessage;
	});
}

function _reset(event) {
	const signupform = document.querySelector('signup-form').$.signupform;
	signupform.reset();
	signupform.querySelector('.output').innerHTML = '';
}
HTMLImports.whenReady(() => {

	class PasswordValidator extends Polymer.mixinBehaviors([Polymer.IronValidatorBehavior], Polymer.Element) {
		static get is() {
			return 'password-validator';
		}

		static get properties() {
			return {
				errorMessage: {
					type: String,
					notify: true
				}
			}
		}

		ready() {
			super.ready();

			// Workaround https://github.com/PolymerElements/iron-validator-behavior/issues/30#issuecomment-305643574
			new Polymer.IronMeta({
				type: 'validator',
				key: PasswordValidator.is,
				value: this
			});
		}

		validate(value) {
			/*if (typeof value=="undefined")
				return true;*/
			if (!value) {
				this.errorMessage = "Please enter password";
				return false;
			}
			if (value.length < 6) {
				this.errorMessage = "Password should have at least 6 characters";
				return false;
			}
			if (!(value.match(/\d/) && value.match(/[A-Z]/))) {
				this.errorMessage = "Password should have 1 digit and 1 uppercase symbol";
				return false;
			}
			return true;
		}
	}
	class EqualityValidator extends Polymer.mixinBehaviors([Polymer.IronValidatorBehavior], Polymer.Element) {
		static get is() {
			return 'equality-validator';
		}
		static get properties() {
			return {
				checkEquatTo: {
					type: String
				}
			}
		}
		ready() {
			super.ready();

			// Workaround https://github.com/PolymerElements/iron-validator-behavior/issues/30#issuecomment-305643574
			new Polymer.IronMeta({
				type: 'validator',
				key: EqualityValidator.is,
				value: this
			});
		}

		validate(value) {
			/*if (typeof value=="undefined")
				return true;*/
			return value === this.checkEqualTo;
		}
	}
	class UsernameValidator extends Polymer.mixinBehaviors([Polymer.IronValidatorBehavior], Polymer.Element) {
		static get is() {
			return 'username-validator';
		}
		static get properties() {
			return {
				errorMessage: {
					type: String,
					notify: true
				},
				oldresult: {
					type: Boolean
				},
				alreadyTaken: {
					type: String
				},
				oldvalue: {
					type: String
				}
			}
		}
		ready() {
			super.ready();
			this.oldvalue = null;
			this.oldresult = false;
			this.alreadyTaken = "";

			// Workaround https://github.com/PolymerElements/iron-validator-behavior/issues/30#issuecomment-305643574
			new Polymer.IronMeta({
				type: 'validator',
				key: UsernameValidator.is,
				value: this
			});
		}

		validate(value) {
			if (typeof value == "undefined")
				return true;
			console.log("AT " + this.alreadyTaken + " ov " + this.oldvalue + " v " + value);
			if (this.alreadyTaken.length && (this.oldvalue == value || this.oldvalue==null)) {
				this.oldvalue = value;
				this.errorMessage = this.alreadyTaken;
				this.oldresult = false;
				return false;
			} else if (this.oldvalue == value)
				return this.oldresult;
			this.alreadyTaken = "";
			this.oldvalue = value;
			if (!value || value.length < 4) {
				this.errorMessage = "Username should be at least 4 character long.";
				this.oldresult = false;
				return this.oldresult;
			}
			let res = /^[A-Za-z0-9_\-]+$/.test(value);
			if (!res) {
				this.errorMessage = "Username should contain only digits, letters, dashes or underscores.";
				this.oldresult = false;
				return this.oldresult;
			}
			this.oldresult = true;
			return true;
		}
	}
	class SignupForm extends Polymer.Element {
		static get is() {
			return 'signup-form';
		}
		static get properties() {
			return {
				data: {
					type: Object,
					value: {},
					notify: true
				},
				passwordErrorMessage: {
					type: String
				},
				usernameErrorMessage: {
					type: String
				},
				usernameTaken: {
					type: String
				}
			}
		}

		_presubmit(e) {
			console.log('presubmit params', this.$.signupform.request.params);
			console.log('presubmit body', this.$.signupform.request.body);
		}

		ready() {
			super.ready();
			let dom = this.$;
			let suf = dom.signupform;
			let params = getUrlParameters();
			let p;
			if (p = params.get('error')) {
				this.usernameTaken = "Error "+p+" in signup!";
			}
			if (p = params.get('username'))
				this.set('data.username',p);
			if (p = params.get('password')) {
				this.set('data.password',p);
				this.set('data.repeat_password',p);
			} else
				this.set('data.repeat_password','');
			let cl = function(event) {
				console.log("Change " + event.target.id);
				console.log("1) " + dom.username.validate());
				console.log("2) " + dom.password.validate());
				console.log("3) " + dom.repeat_password.validate());
				console.log("4) " + suf.validate());
				console.log("5) " + suf._form.checkValidity());
				let vale = suf._getValidatableElements();
				vale.forEach(function(el, idx) {
					if (el['validate'])
						console.log("" + (6 + idx) + ") " + el.id + " " + el.validate());
				});

				let v1 = dom.username.validate(),
					v2 = dom.password.validate(),
					v3 = dom.repeat_password.validate();
				dom.signupsubmit.disabled = !(v1 && v2 && v3);
			}
			dom.username.addEventListener('input', cl);
			dom.password.addEventListener('input', cl);
			dom.repeat_password.addEventListener('input', cl);
			suf.addEventListener('change', cl);
			suf.addEventListener('iron-form-presubmit', function() {
				// this.request.method = 'put';
				console.log('presubmit params', suf.request.params);
				console.log('presubmit body', suf.request.body);
			});

			suf.addEventListener('iron-form-submit', function(event) {
				dom.spinner.active = false;
				dom.spinner.hidden = true;
				dom.signupsubmit.disabled = false;
				document.querySelector('.output').innerHTML = JSON.stringify(event.detail);
			});

			suf.addEventListener('iron-form-response', function(e) {
				const response = e.detail.response;
				document.querySelector('.output').innerHTML = JSON.stringify(response, null, 2);
			});
		}
		submit() {
			let params = getUrlParameters();
			let v;
			this.shadowRoot.querySelector('[name="redirect_uri"]').value = (v = params.get('redirect_uri'))?v:"";
			this.shadowRoot.querySelector('[name="client_id"]').value = (v = params.get('client_id'))?v:"";
			this.shadowRoot.querySelector('[name="redirect_uri"]').value = (v = params.get('redirect_uri'))?v:"";
			this.shadowRoot.querySelector('[name="state"]').value = (v = params.get('state'))?v:"";
			this.shadowRoot.querySelector('[name="username"]').value = this.shadowRoot.querySelector('paper-input[name="paper_username"]').value;
			this.shadowRoot.querySelector('[name="password"]').value = this.shadowRoot.querySelector('paper-input[name="paper_password"]').value;
			this.$.signupforminner.submit();
		}

	}
	window.customElements.define(SignupForm.is, SignupForm);
	window.customElements.define(PasswordValidator.is, PasswordValidator);
	window.customElements.define(UsernameValidator.is, UsernameValidator);
	window.customElements.define(EqualityValidator.is, EqualityValidator);
	/*const signupform = document.getElementById('signupform');
	const signupsubmit = document.getElementById('signupsubmit');
	const spinner = document.getElementById('spinner');*/
});
</script>
</body>

</html>